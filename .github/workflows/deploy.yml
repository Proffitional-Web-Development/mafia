name: Deploy Production

on:
  push:
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  NODE_VERSION: "20"

jobs:
  deploy-convex:
    name: Deploy Convex to Production
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Deploy Convex functions
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
        run: npx convex deploy --cmd "echo 'Convex deploy complete'"

  deploy-vercel:
    name: Deploy Vercel Production
    runs-on: ubuntu-latest
    needs: deploy-convex
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Pull Vercel environment
        run: vercel pull --cwd web --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build
        run: vercel build --cwd web --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        id: deploy
        run: |
          url=$(vercel deploy --cwd web --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> "$GITHUB_OUTPUT"

      - name: Deployment URL
        run: echo "Deployed to ${{ steps.deploy.outputs.url }}"

  post-deploy-check:
    name: Post-Deploy Smoke Test
    runs-on: ubuntu-latest
    needs: deploy-vercel
    steps:
      - name: Health check
        env:
          SITE_URL: ${{ secrets.PRODUCTION_URL }}
        run: |
          echo "Checking $SITE_URL/api/health..."
          for i in 1 2 3 4 5; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL/api/health" || echo "000")
            if [ "$status" = "200" ]; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i returned $status, retrying in 10s..."
            sleep 10
          done
          echo "Health check failed after 5 attempts"
          exit 1
